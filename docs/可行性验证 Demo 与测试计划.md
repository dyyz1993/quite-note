# 可行性验证 Demo 与测试计划（QuiteNote）

## 说明
- 依据 `/Users/xuyingzhou/Project/study-mac-app/quite-note/.trae/documents/悬浮记录本 macOS 应用 + 蓝牙按钮 + AI提炼 实施方案.md` 的功能与约束，拆解需要编写的 Demo 与测试验证方案。
- 涵盖 BLE、悬浮窗与动效、状态栏菜单、剪贴板采集与去重、RecordStore、热力图联动、AI 提炼、偏好设置、快捷键、通知与轻提示、导出/导入、安全与隐私、性能与稳定性、集成链路。
- 每节包含：目标、最小可行 Demo、测试与验证、真实数据案例、通过标准。

---

## BLE 按钮事件 Demo
- 目标：Central 连接自定义 GATT，订阅 `CHAR_BUTTON_EVT`，解析事件帧并写回 `CHAR_ACK`，实现 1 秒防抖与指数退避（文档 18–33 行）。
- 最小可行 Demo：
  - 扫描并连接 `SERVICE=12345678-1234-5678-1234-567812345678`；发现并订阅 `CHAR_BUTTON_EVT(Notify)`；发现 `CHAR_ACK(WriteWithoutResponse)`。
  - 解析事件载荷 Byte0 `event_id`（0x01/0x02/0x10）、Byte1 `seq`、Byte2 `flags`（bit0 长按、bit1 双击）。
  - 对每个事件按 `event_id+seq` 去重与 1 秒时间窗防抖；回写 ACK：`status=0x00/0x01/0x02/0x03` 与原 `seq`。
  - 状态机：`Disconnected→Scanning→Connecting→Discovering→Subscribing→Ready`；失败退避 0.5s→1s→2s…≤10s；日志与指标上报。
- 测试与验证：
  - 连通性：首次连接 <3s；断连后自动重连；乱序/丢包不重复处理。
  - 事件正确性：长按/双击 flag 解析；心跳节流；重复 `event_id+seq` 忽略。
  - ACK 时序：收到事件→处理→回写 ACK≤20ms，ACK 成功率 100%。
  - 抗干扰：RSSI 变化、外围设备消失/重现；指数退避符合阈值。
- 真实数据案例：
  - 硬件发送 `0x01 seq=34`→采集剪贴板→保存记录→回写 `0x00 34`（文档 101 行）。
  - 硬件发送 `0x02 seq=35`→展开悬浮窗→再次 `0x02`→收起（文档 101 行）。
- 通过标准：端到端事件处理 P95 <50ms；重复处理率=0；连接稳定运行 24h 无崩溃。

---

## 悬浮窗与动效 Demo
- 目标：`NSPanel` 置顶、跨桌面显示（文档 35 行），展收动效 300/250ms 与单项展开 200ms（53–56 行），拖拽与位置锁定，复制后 2s 气泡提示。
- 最小可行 Demo：SwiftUI Hosting `NSPanel(level: .floating, collectionBehavior: .canJoinAllSpaces)`；展收动效；条目展开动画；双击复制后右侧气泡提示。
- 测试与验证：
  - 全屏交互：在全屏 Safari/Xcode 下不遮挡系统关键窗口；切换空间保持可见。
  - 动画性能：循环展收 1,000 次，帧率≥60fps；掉帧<1%；无抖动。
  - 交互：拖拽移动与位置锁定生效；双击复制触发气泡且自动消失。
- 真实数据案例：复制真实中文段落触发反馈；在多桌面频繁切换验证窗口行为。
- 通过标准：平均帧时 <16.7ms；位置锁定阻止移动；反馈提示无重叠与风暴。

---

## 状态栏菜单与指示 Demo
- 目标：实现菜单结构（文档 77–88 行）与蓝牙状态图标三态、hover 显示设备名（文档 9 行）。
- 最小可行 Demo：`NSStatusBar` 图标；已连/未连/重连中；菜单项动作绑定；hover 气泡显示设备名。
- 测试与验证：状态切换实时；菜单可用性灰化逻辑正确；快捷入口触发悬浮窗展收。
- 真实数据案例：在 BLE 连接/重连/断连循环中观察图标与菜单响应。
- 通过标准：点击响应 <100ms；状态一致性 100%。

---

## 剪贴板采集与去重 Demo
- 目标：`NSPasteboard` 监控，空剪贴板轻提示（文档 13 行），10 分钟去重（文档 13 行），双击复制反馈（文档 14 行）。
- 最小可行 Demo：内容哈希；空值检测与提示节流；时间窗去重；记录生成与反馈。
- 测试与验证：
  - 中文办公文本、多段落与超长文本；复制→采集闭环；
  - 10 分钟内重复内容不入库；空剪贴板仅提示一次。
- 真实数据案例：文档 96–100 行给出的文本片段；批量连续复制真实内容。
- 通过标准：采集耗时 P95 <30ms；去重正确；提示无抖动。

---

## RecordStore 存储与搜索 Demo
- 目标：CoreData/SQLite 存储（文档 39 行），索引与搜索；星标/删除/编辑；导出 txt/Markdown（文档 39、12 行）。
- 最小可行 Demo：`Record` 模型（文档 48 行）；CRUD 与搜索；分页最近 10 条；导出到 `~/Library/Application Support/QuiteNote/`（文档 94 行）。
- 测试与验证：重启后持久化；搜索实时过滤与正确性；编辑一致性；导出文件编码。
- 真实数据案例：导入 10k+ 真实记录（来自历史剪贴板）；搜索中文关键词与星标筛选。
- 通过标准：查询延迟 P95 <50ms；写入 P95 <20ms；导出文件 UTF-8 无乱码。

---

## 热力图联动 Demo
- 目标：日/周/月聚合、主题切换、点击联动筛选与 tooltip（文档 59–62 行）。
- 最小可行 Demo：按 `createdAt` 聚合矩阵；周视图 7×N；月视图按天数；点击色块过滤；tooltip 显示 `yyyy-MM-dd：N 条`（文档 102 行）。
- 测试与验证：跨月与闰年边界；联动更新延迟；深浅色主题一致性。
- 真实数据案例：真实记录日期分布；抽查手算计数对比。
- 通过标准：计数误差=0；联动延迟 P95 <50ms。

---

## AI 提炼 Demo
- 目标：本地/云端模型适配（文档 42 行），固定 JSON 输出（文档 65–72 行），超时降级与重试（文档 74 行），标题/总结长度约束与降级规则（文档 73–75 行）。
- 最小可行 Demo：`AIService` 抽象层；5s 超时返回（标题=前15字，总结空）；失败缓存任务重试一次；“点击重试”入口；`Keychain` 存云端 API Key（文档 93 行）。
- 测试与验证：
  - 真实中文文本与长文本；网络错误与超时注入；无效结果校验与忽略；
  - 速率限制与并发；`confidence` 合理范围。
- 真实数据案例：文档 96–100 行文本；链接/代码/纯数字内容触发降级规则（文档 73 行）。
- 通过标准：成功率≥95%；JSON 校验 100%；超时降级一致；长度约束命中。

---

## 偏好设置与配置存储 Demo
- 目标：分标签页（蓝牙/记录/AI/悬浮窗/热力图；文档 43、89–90 行），`UserDefaults` + `Keychain`（文档 43、93 行），导入/导出 `.plist`（文档 89 行）。
- 最小可行 Demo：默认值与重置；敏感项密钥安全存储；即时生效；导入/导出与校验。
- 测试与验证：设置切换后 UI/功能即时生效；重启持久；导入非法文件提示。
- 真实数据案例：真实 API Key 与配置切换；主题调整观察热力图变化。
- 通过标准：设置生效延迟 <100ms；密钥不出现在日志；导入失败有明确提示。

---

## 快捷键 Demo
- 目标：`Option+Cmd+R` 展收（文档 83 行）、`Option+Cmd+A` 切换 AI（文档 84 行）。
- 最小可行 Demo：全局热键注册与菜单动作一致；冲突检测与用户提示。
- 测试与验证：前后台与全屏生效；与系统/其他 App 冲突时提示并可更改。
- 真实数据案例：常用组合冲突测试；记录触发成功率。
- 通过标准：触发成功率≥99%；无静默失败。

---

## 通知与轻提示 Demo
- 目标：复制/错误轻提示为主，系统通知为辅（文档 92 行）。
- 最小可行 Demo：应用内提示栈与节流；系统通知权限管理与降级策略。
- 测试与验证：高频错误注入；提示合并与节流；权限拒绝场景回归。
- 真实数据案例：复制失败/AI 错误/蓝牙断连的提示行为。
- 通过标准：无提示风暴；用户可辨识且不打断主流程。

---

## 导出/导入记录 Demo
- 目标：底部按钮与二次确认（文档 12 行）、导出所有记录（文档 87 行）、沙盒路径限制（文档 94 行）。
- 最小可行 Demo：导出 txt/Markdown；二次确认；文件写入到应用支持目录；导入合并/覆盖策略与校验。
- 测试与验证：中文编码；大文件性能；错误路径与权限错误提示。
- 真实数据案例：导出 100k 真实记录；计算哈希并校验；再导入验证一致性。
- 通过标准：写入 P95 <100ms/MB；内容一致性；错误有明确提示。

---

## 安全与隐私验证
- 目标：`Keychain` 存储云端密钥（文档 93 行）、加密传输说明（文档 75 行）、日志脱敏与最小化。
- 测试与验证：全局搜敏感打印；加解密与读取流程；配置篡改回退；隐私提示文本校验。
- 真实数据案例：真实 API Key 流转；抓取日志验证无泄露。
- 通过标准：0 条敏感日志；密钥仅可通过授权读取；异常回退可靠。

---

## 性能与稳定性
- 指标：UI 帧率、事件端到端处理耗时、读写 P95、内存占用、崩溃率（文档 117–121 行）。
- 方法：打点与采样；24h 长跑；断连/重连/无网络/大量记录滚动筛选场景压力测试（文档 120–121 行）。
- 通过标准：无崩溃；端到端可靠≥99%；内存稳定<500MB；UI 无明显卡顿。

---

## 集成场景链路
- 场景：
  - `0x01` 采集→保存→ACK→悬浮窗不弹出（文档 101 行）。
  - `0x02` 展开→再次 `0x02` 收起（文档 101 行）。
  - 热力图点击筛选与 tooltip（文档 102 行）。
- 测试与验证：真实按钮序列与剪贴板内容贯穿；观测 UI 与存储一致；端到端打点统计。
- 通过标准：链路无漏步；状态一致性；端到端耗时 P95 <150ms。

---

## 工具与环境
- macOS 13+、Xcode 15+；真实 BLE 外设或手机模拟器（nRF Connect/LightBlue）。
- 本地推理服务（如 Llama 系列）或云端 API；云端密钥存 `Keychain`。
- 指标采集与日志：统一格式、统一入口，严禁打印敏感信息。

---

## 验收与里程碑对应
- 里程碑 A–F（文档 109–116 行）分别以上述各 Demo 的“通过标准”为准入门槛。
- 每里程碑交付：可运行预览 + 测试报告 + 指标摘要（成功率、耗时 P95、异常汇总）。

