name: Build macOS App

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: å®‰è£…ImageMagickï¼ˆç”¨äºŽå›¾æ ‡è½¬æ¢ï¼‰
      run: |
        brew install imagemagick
        
    - name: éªŒè¯Swift Package
      run: |
        swift package resolve
        
    - name: æž„å»ºReleaseç‰ˆæœ¬
      run: |
        swift build -c release --product QuiteNote
        
    - name: åˆ›å»ºåº”ç”¨åŒ…ç»“æž„
      run: |
        chmod +x build-app.sh
        ./build-app.sh
        
    - name: éªŒè¯åº”ç”¨åŒ…
      run: |
        ls -la "Quite Note.app/Contents/"
        file "Quite Note.app/Contents/MacOS/QuiteNote"
        
    - name: åˆ›å»ºDMGå®‰è£…åŒ…
      run: |
        echo "ðŸ” æ£€æŸ¥DMGåˆ›å»ºè„šæœ¬..."
        if [ -f "create-dmg.sh" ]; then
          echo "âœ… æ‰¾åˆ°DMGåˆ›å»ºè„šæœ¬"
          chmod +x create-dmg.sh
          echo "ðŸš€ å¼€å§‹åˆ›å»ºDMG..."
          ./create-dmg.sh
          echo "ðŸ” æ£€æŸ¥DMGæ–‡ä»¶..."
          if [ -f "QuiteNote-1.0.0.dmg" ]; then
            echo "âœ… DMGåˆ›å»ºæˆåŠŸ:"
            ls -la QuiteNote-*.dmg
            # éªŒè¯DMGæ–‡ä»¶
            echo "ðŸ” éªŒè¯DMGæ–‡ä»¶å®Œæ•´æ€§..."
            hdiutil attach -quiet -readonly -mountpoint /tmp/dmg_test QuiteNote-1.0.0.dmg
            if [ -d "/tmp/dmg_test/Quite Note.app" ]; then
              echo "âœ… DMGæ–‡ä»¶éªŒè¯æˆåŠŸï¼Œåº”ç”¨åŒ…å®Œæ•´"
            else
              echo "âŒ DMGæ–‡ä»¶éªŒè¯å¤±è´¥"
              exit 1
            fi
            hdiutil detach -quiet /tmp/dmg_test
          else
            echo "âŒ DMGåˆ›å»ºå¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ DMGåˆ›å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡DMGç”Ÿæˆ"
        fi
        
    - name: æ£€æŸ¥æž„å»ºäº§ç‰©
      run: |
        echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "ðŸ” æ£€æŸ¥åº”ç”¨åŒ…:"
        if [ -d "Quite Note.app" ]; then
          echo "âœ… åº”ç”¨åŒ…å­˜åœ¨: Quite Note.app"
          ls -la "Quite Note.app/Contents/"
        else
          echo "âŒ åº”ç”¨åŒ…ä¸å­˜åœ¨"
        fi
        echo ""
        echo "ðŸ” æ£€æŸ¥DMGæ–‡ä»¶:"
        if [ -f "QuiteNote-1.0.0.dmg" ]; then
          echo "âœ… DMGæ–‡ä»¶å­˜åœ¨:"
          ls -la QuiteNote-*.dmg
        else
          echo "âŒ DMGæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: QuiteNote-macOS-DMG-${{ github.run_number }}
        path: |
          QuiteNote-*.dmg
        retention-days: 30
        if-no-files-found: error
        
    - name: ä¸Šä¼ åº”ç”¨åŒ…ï¼ˆå¤‡ç”¨ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: QuiteNote-macOS-APP-${{ github.run_number }}
        path: |
          Quite Note.app
        retention-days: 7
        if-no-files-found: warn
      continue-on-error: true
        
    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ -f "Package.swift" ]; then
          VERSION=$(grep -o 'version: "[^"]*"' Package.swift | head -1 | cut -d'"' -f2)
        else
          VERSION="1.0.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»ºGitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          QuiteNote-*.dmg
          Quite Note.app
        generate_release_notes: true
        draft: false
        prerelease: false
        name: Quite Note ${{ github.ref_name }}
        body: |
          ðŸŽ‰ **Quite Note ${{ github.ref_name }} å‘å¸ƒ**
          
          åŸºäºŽSwiftUIçš„macOSå‰ªåˆ‡æ¿åŽ†å²è®°å½•å’ŒAIæç‚¼å·¥å…·
          
          ## ðŸ“¦ ä¸‹è½½æ–‡ä»¶ï¼ˆæŽ¨èé¡ºåºï¼‰
          ### ðŸ¥‡ **DMGå®‰è£…åŒ…ï¼ˆæŽ¨èç”¨æˆ·ä½¿ç”¨ï¼‰**
          - `QuiteNote-*.dmg` - ä¸€é”®å®‰è£…åŒ…ï¼ŒåŒ…å«åº”ç”¨ç¨‹åºå’ŒApplicationså¿«æ·æ–¹å¼
          
          ### ðŸ¥ˆ **åº”ç”¨åŒ…ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰**
          - `Quite Note.app` - å®Œæ•´çš„macOSåº”ç”¨åŒ…
          
          ## ðŸš€ å®‰è£…è¯´æ˜Ž
          ### DMGå®‰è£…ï¼ˆæŽ¨èï¼‰â­
          1. ä¸‹è½½ `QuiteNote-*.dmg` æ–‡ä»¶
          2. åŒå‡»DMGæ–‡ä»¶æŒ‚è½½
          3. å°† "Quite Note.app" æ‹–æ‹½åˆ° "Applications" æ–‡ä»¶å¤¹
          4. åœ¨ Launchpad æˆ– Applications æ–‡ä»¶å¤¹ä¸­å¯åŠ¨åº”ç”¨
          5. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¦‚é‡å®‰å…¨æç¤ºï¼Œè¯·åœ¨ "ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸Žéšç§" ä¸­å…è®¸
          
          ### åº”ç”¨åŒ…å®‰è£…ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰
          1. ä¸‹è½½ `Quite Note.app` æ–‡ä»¶
          2. æ‰‹åŠ¨ç§»åŠ¨åˆ° Applications æ–‡ä»¶å¤¹
          3. å³é”®ç‚¹å‡»åº”ç”¨ï¼Œé€‰æ‹©"æ‰“å¼€"
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          - ðŸŽ¨ è‡ªå®šä¹‰å‰ªåˆ‡æ¿+AIé—ªå…‰ä¸»é¢˜å›¾æ ‡
          - ðŸ”§ æ”¹è¿›çš„LucideIconsåŠ è½½æœºåˆ¶ï¼ˆä¿®å¤ç¬¬ä¸‰æ–¹å›¾æ ‡æ‰“åŒ…é—®é¢˜ï¼‰
          - ðŸ“± ä¼˜åŒ–çš„çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤º
          - ðŸ“‹ å®Œæ•´çš„å‰ªåˆ‡æ¿åŽ†å²è®°å½•ç®¡ç†
          - ðŸ¤– AIå†…å®¹æç‚¼åŠŸèƒ½
          - ðŸ”’ å®Œæ•´çš„ä»£ç ç­¾åï¼Œé¿å…"æŸå"æç¤º
          
          ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
          - macOS 12.0 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ”¯æŒIntelå’ŒApple Siliconï¼ˆé€šç”¨äºŒè¿›åˆ¶ï¼‰
          
          ---
          ðŸ“… æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          ðŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}
          ðŸ·ï¸ æž„å»ºç¼–å·: ${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æž„å»ºä¿¡æ¯
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: |
        echo "## ðŸš€ QuiteNote macOS åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åº”ç”¨åŒ…: Quite Note.app" >> $GITHUB_STEP_SUMMARY
        if [ -f "QuiteNote-1.0.0.dmg" ]; then
          echo "- âœ… å®‰è£…åŒ…: $(ls QuiteNote-*.dmg)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“… æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ æž„å»ºç¼–å·: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "1. è®¿é—® Actions é¡µé¢" >> $GITHUB_STEP_SUMMARY
        echo "2. ç‚¹å‡»æ­¤å·¥ä½œæµçš„æž„å»ºä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
        echo "3. åœ¨ 'Artifacts' éƒ¨åˆ†ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY