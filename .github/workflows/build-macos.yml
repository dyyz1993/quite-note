name: Build macOS App

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: å®‰è£…ImageMagickï¼ˆç”¨äºŽå›¾æ ‡è½¬æ¢ï¼‰
      run: |
        brew install imagemagick
        
    - name: éªŒè¯Swift Package
      run: |
        swift package resolve
        
    - name: æž„å»ºReleaseç‰ˆæœ¬
      run: |
        swift build -c release --product QuiteNote
        
    - name: åˆ›å»ºåº”ç”¨åŒ…ç»“æž„
      run: |
        chmod +x build-app.sh
        ./build-app.sh
        
    - name: éªŒè¯åº”ç”¨åŒ…
      run: |
        ls -la "Quite Note.app/Contents/"
        file "Quite Note.app/Contents/MacOS/QuiteNote"
        
    - name: åˆ›å»ºDMGå®‰è£…åŒ…
      run: |
        if [ -f "create-dmg.sh" ]; then
          chmod +x create-dmg.sh
          ./create-dmg.sh
        else
          echo "DMGåˆ›å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡DMGç”Ÿæˆ"
        fi
        
    - name: æ£€æŸ¥æž„å»ºäº§ç‰©
      run: |
        echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "ðŸ” æ£€æŸ¥åº”ç”¨åŒ…:"
        if [ -d "Quite Note.app" ]; then
          echo "âœ… åº”ç”¨åŒ…å­˜åœ¨: Quite Note.app"
          ls -la "Quite Note.app/Contents/"
        else
          echo "âŒ åº”ç”¨åŒ…ä¸å­˜åœ¨"
        fi
        echo ""
        echo "ðŸ” æ£€æŸ¥DMGæ–‡ä»¶:"
        if [ -f "*.dmg" ]; then
          echo "âœ… DMGæ–‡ä»¶å­˜åœ¨:"
          ls -la *.dmg
        else
          echo "âŒ DMGæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: QuiteNote-macOS-${{ github.run_number }}
        path: |
          Quite Note.app
          *.dmg
        retention-days: 30
      continue-on-error: true
        
    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ -f "Package.swift" ]; then
          VERSION=$(grep -o 'version: "[^"]*"' Package.swift | head -1 | cut -d'"' -f2)
        else
          VERSION="1.0.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: æž„å»ºä¿¡æ¯
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      run: |
        echo "## ðŸš€ QuiteNote macOS åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åº”ç”¨åŒ…: Quite Note.app" >> $GITHUB_STEP_SUMMARY
        if [ -f "*.dmg" ]; then
          echo "- âœ… å®‰è£…åŒ…: $(ls *.dmg)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“… æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ æž„å»ºç¼–å·: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "1. è®¿é—® Actions é¡µé¢" >> $GITHUB_STEP_SUMMARY
        echo "2. ç‚¹å‡»æ­¤å·¥ä½œæµçš„æž„å»ºä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
        echo "3. åœ¨ 'Artifacts' éƒ¨åˆ†ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY