name: Build macOS App

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: å®‰è£…ImageMagickï¼ˆç”¨äºå›¾æ ‡è½¬æ¢ï¼‰
      run: |
        brew install imagemagick
        
    - name: éªŒè¯Swift Package
      run: |
        swift package resolve
        
    - name: æ„å»ºReleaseç‰ˆæœ¬
      run: |
        swift build -c release --product QuiteNote
        
    - name: åˆ›å»ºåº”ç”¨åŒ…ç»“æ„
      run: |
        chmod +x build-app.sh
        ./build-app.sh
        
    - name: éªŒè¯åº”ç”¨åŒ…
      run: |
        ls -la "Quite Note.app/Contents/"
        file "Quite Note.app/Contents/MacOS/QuiteNote"
        
    - name: åˆ›å»ºDMGå®‰è£…åŒ…
      run: |
        if [ -f "create-dmg.sh" ]; then
          chmod +x create-dmg.sh
          ./create-dmg.sh
        else
          echo "DMGåˆ›å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡DMGç”Ÿæˆ"
        fi
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: QuiteNote-macOS
        path: |
          Quite Note.app
          *.dmg
        retention-days: 30
        
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ -f "Package.swift" ]; then
          VERSION=$(grep -o 'version: "[^"]*"' Package.swift | head -1 | cut -d'"' -f2)
        else
          VERSION="1.0.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»ºRelease
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
        name: QuiteNote v${{ steps.version.outputs.version }}-${{ github.run_number }}
        body: |
          ## QuiteNote macOS åº”ç”¨æ„å»º
          
          ### æ–°åŠŸèƒ½
          - ğŸ¨ è‡ªå®šä¹‰å‰ªåˆ‡æ¿+AIé—ªå…‰ä¸»é¢˜å›¾æ ‡
          - ğŸ”§ æ”¹è¿›çš„LucideIconsåŠ è½½æœºåˆ¶
          - ğŸ“± ä¼˜åŒ–çš„çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤º
          
          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `Quite Note.app` æˆ– `QuiteNote.dmg`
          2. å¦‚æœä¸‹è½½äº†DMGï¼ŒåŒå‡»æŒ‚è½½å¹¶æ‹–æ‹½åº”ç”¨åˆ°Applicationsæ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
          
          ### ç³»ç»Ÿè¦æ±‚
          - macOS 12.0 æˆ–æ›´é«˜ç‰ˆæœ¬
          
          ### æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - æ„å»ºç¼–å·: ${{ github.run_number }}
        files: |
          Quite Note.app
          *.dmg
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}