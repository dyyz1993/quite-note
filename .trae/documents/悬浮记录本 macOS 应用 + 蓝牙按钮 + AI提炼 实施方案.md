## 目标与范围
- 打造可悬浮、始终置顶的 macOS 记录本应用，支持蓝牙硬件两枚按钮交互（采集剪贴板、唤起/收起历史）。
- 提供最近 10 条记录的高效浏览、展开、复制反馈与动效，支持搜索、星标、删除、导出。
- 侧边展示 GitHub 风格热力图并与记录联动筛选。
- 接入大模型进行“无标题新内容”的自动提炼（标题+总结），可配置触发条件、长度、详略程度、本地/云端模型切换。
- 设计清晰的菜单栏入口与「偏好设置」窗口，提供蓝牙与 AI 的细粒度控制。

## 交互补充与优化
- 蓝牙状态反馈：未连接点击硬件按钮时弹出 3 秒轻提示；连接中显示「连接中…」边缘动画；状态栏图标区分已连/未连/重连中，hover 显示设备名。
- 防抖与闭环：同一按钮 1 秒防抖；历史面板已展开时再次按“唤起历史”执行收起；动画统一规范（展开 300ms、收起 250ms、单项展开 200ms）。
- 手动入口：悬浮窗右上添加「最小化」「关闭」；支持拖拽与「位置锁定」。
- 记录管理：每条记录 hover 显示「更多」进行删除/星标/编辑标题总结；顶部搜索实时过滤；底部提供「清空历史」「导出记录」并二次确认。
- 去重与空剪贴板：10 分钟去重策略；剪贴板为空时显示轻提示。
- 复制提醒：双击复制后右侧气泡提示 +「已复制」标记短暂显现。
- AI 提炼可控：记录右侧显示「提炼中…」动画、失败降级与手动重试；可全局关闭。
- 热力图联动：支持日/周/月切换；点击色块筛选该时间段记录；tooltip 显示当日数量。

## 蓝牙协议与状态机
- 角色：硬件为 BLE Peripheral，Mac 应用为 Central，使用 `CoreBluetooth` 订阅通知。
- GATT 设计：
  - `SERVICE`：`12345678-1234-5678-1234-567812345678`（示例，自定义 128-bit）。
  - `CHAR_BUTTON_EVT`（Notify）：按钮事件上报。
  - `CHAR_ACK`（WriteWithoutResponse）：Mac 回写 ACK/错误码。
  - 可选 `CHAR_BATTERY`（Read/Notify）：硬件电量（提升用户感知）。
- 事件载荷（1~4 字节，简洁鲁棒）：
  - Byte0 `event_id`：`0x01`=采集剪贴板、`0x02`=唤起/收起历史、`0x10`=心跳。
  - Byte1 `seq`：递增序号（配合防抖与去重）。
  - Byte2 `flags`：保留位，`bit0`=长按，`bit1`=双击（可扩展）。
  - Byte3 `reserved`：预留。
- ACK 载荷（2 字节）：Byte0 `status`（`0x00`成功、`0x01`未连接、`0x02`忙、`0x03`无效）、Byte1 `seq` 回传。
- 状态机：`Disconnected→Scanning→Connecting→Discovering→Subscribing→Ready`；重连退回 `Scanning`，失败指数退避（0.5s→1s→2s→…≤10s）。
- 防抖策略：同一 `event_id+seq` 只处理一次；时间窗 1s 内同事件忽略重复。

## 应用架构（Swift/SwiftUI 原生）
- UI 框架：`SwiftUI` + `AppKit` 桥接；悬浮窗使用 `NSPanel`，`level = .floating`，`collectionBehavior = .canJoinAllSpaces`，支持拖拽与缩放。
- 关键模块：
  - `BluetoothManager`：CoreBluetooth 连接、事件解析、ACK、状态广播。
  - `ClipboardService`：监控与读取 `NSPasteboard`，空剪贴板检测、去重策略。
  - `RecordStore`：本地存储（`CoreData` 或 `SQLite`），索引与搜索；导出 txt/Markdown。
  - `FloatingPanelController`：悬浮窗口展示、10 条分页滚动、展开/复制反馈动效。
  - `HeatmapViewModel / HeatmapView`：按日/周/月聚合、点击筛选、tooltip。
  - `AIService`：本地/云端模型适配、速率限制、超时降级与重试。
  - `PreferencesView`：分标签页配置；`UserDefaults`+安全项（`Keychain`）存储。
  - `StatusBarController`：菜单栏图标、快捷入口与状态指示。
- 响应式：使用 `Combine` 在 `BluetoothManager`、`ClipboardService`、`RecordStore`、`AIService` 之间分发状态与事件。

## 数据模型
- `Record`: `id`、`content`、`createdAt`、`title?`、`summary?`、`aiStatus`（pending/success/fail）、`summaryConfidence?`、`starred`、`copiedAt?`、`hash`（去重）。
- `Device`: `name`、`identifier`、`rssi?`、`battery?`、`lastSeenAt`、`state`（disconnected/connecting/ready）。
- `Preferences`: 蓝牙重连、按钮防抖时长、记录保留条数、去重开关、过期清理天数、排序方式、AI 开关、标题/总结长度、详略程度、模型源、本地/云端参数、快捷键、动效开关、热力图主题与维度等。
- `SummaryTask`: `recordId`、`trigger`（auto/manual/bulk） 、`attempts`、`lastError?`。

## 悬浮窗与动画规范
- 展开：状态栏图标位置弹出，缩放+淡入，`~300ms`；收起：缩放+淡出至图标，`~250ms`。
- 单条记录展开：高度平滑过渡 `~200ms`；复制气泡提示 2 秒自动消失。
- 交互：双击复制；点击「更多」弹出操作；拖拽顶部区域移动；「位置锁定」阻止移动。
- 置顶与多桌面：`canJoinAllSpaces + ignoresCycle`，确保多桌面均可见且不影响 App 切换。

## 热力图实现与联动
- 数据聚合：按日生成计数矩阵；周视图 7×N、月视图按实际天数；支持深浅色主题。
- 交互：点击色块过滤对应时间段记录；hover 显示 `yyyy-MM-dd：N 条`；底部按钮切换日/周/月。

## AI 提炼任务规范
- 触发：仅新记录触发；原文长度 ≥N 触发总结；标题默认提炼（可关闭）；编辑后支持手动“重新提炼”。
- 固定输出 JSON：
```json
{
  "title": "不超过X字的标题",
  "summary": "不超过Y字的原文总结",
  "confidence": 0.92
}
```
- 约束：标题 15–25 字、统一风格（可选：简洁/疑问/陈述）；总结 50–100 字，去冗余；链接/代码/纯数字直接降级为截取前 20 字 +「无需总结」。
- 容错：5s 超时直接返回（标题=前 15 字，总结为空），后台缓存任务重试一次；无效结果自动忽略并提示「点击重试」。
- 隐私：优先本地模型（如 Llama 3 8B 量化，走本地推理服务），云端需 API 密钥自配并加密存储于 `Keychain`；明确提示加密传输与用途。

## 配置入口设计
- 菜单栏：
```
📝 悬浮记录本
├── 蓝牙状态：已连接 [设备名]
├── 🔗 连接蓝牙设备（已配对列表 + 添加设备）
├── 📌 悬浮窗：显示/隐藏（`Option+Cmd+R`）
├── ✨ AI提炼：开启/关闭（`Option+Cmd+A`）
├── ⚙️ 偏好设置
├── 📤 导出所有记录
└── ❌ 退出应用
```
- 偏好设置标签页：蓝牙设置、记录设置、AI 提炼设置、悬浮窗设置、热力图设置；页底提供「重置为默认值」「导入/导出 `.plist`」与每项 `?` tooltip。

## 权限与安全
- 通知：`UNUserNotificationCenter` 申请与管理，复制与错误轻提示走应用内气泡为主、系统通知为辅。
- 密钥：云端 API Key 存 `Keychain`；配置走 `UserDefaults`（非敏感）。
- 存储：数据文件位于 `~/Library/Application Support/QuiteNote/`，导出与导入受沙盒路径限制。

## 真实数据与流程案例
- 剪贴板真实片段示例（中文办公场景）：
  - 原文："本周 OKR：1）补齐蓝牙断连重试；2）悬浮窗动效统一；3）AI 提炼失败降级。"
  - 触发：新记录，长度 ≥ 20，AI 自动提炼。
  - 期望输出：`title="本周 OKR 与核心改进"`，`summary="围绕蓝牙重连、悬浮动效统一、AI 提炼的降级方案展开执行。"`，`confidence≈0.9`。
- 蓝牙按钮序列：硬件发送 `0x01 seq=34`→应用采集剪贴板→保存记录→回写 ACK `0x00 34`→悬浮窗不弹出；硬件发送 `0x02 seq=35`→应用展开悬浮窗→再次 `0x02`→应用收起。
- 热力图联动：点击 `2025-12-05` 的色块，右侧仅显示该日记录，tooltip 显示 "2025-12-05：8 条记录"。

## 风险与兼容性
- BLE 外设协议差异与抗干扰：建议提前锁定 GATT 与时序，提供日志与调试面板。
- 多桌面与全屏 App 覆盖：`canJoinAllSpaces` 需测试与全屏应用的交互，不遮挡系统关键窗口。
- 大文本剪贴板：超长文本异步保存与提炼，避免卡顿；图片/富文本暂不提炼，仅保存源信息。

## 开发分解与里程碑
- 里程碑 A：项目骨架与菜单栏、悬浮窗基础（置顶、动效、10 条滚动）。
- 里程碑 B：CoreBluetooth 连接、按钮事件解析、防抖与 ACK；状态栏设备指示。
- 里程碑 C：剪贴板采集、去重策略、Record 存储与搜索、复制反馈。
- 里程碑 D：热力图聚合与交互联动、主题切换。
- 里程碑 E：AIService 适配（本地/云端）、JSON 规范、超时降级与重试、偏好设置页面。
- 里程碑 F：导出/导入配置与数据、快捷键、批量重新提炼、稳定性打磨与测试。

## 测试与验证
- 单元测试：事件解析、防抖、去重、聚合统计、JSON 校验。
- 集成测试：BLE 模拟器回放按钮序列、悬浮窗动画与交互、AI 超时与失败降级链路。
- 场景测试：断连/重连、无网络、云端 API 错误、剪贴板为空、大量记录滚动与筛选。

## 后续扩展
- 支持图片/链接特殊渲染、Markdown 高亮；跨设备同步（iCloud/本地网）。
- 记录标签与分组、批量操作；可视化提炼差异对比与撤销。

## 结论与确认
- 上述方案覆盖交互、协议、架构、隐私与配置入口，贴合 Mac 用户习惯与蓝牙硬件场景。
- 若确认方向与权衡取舍（原生 SwiftUI + CoreBluetooth + 可选本地/云端 AI），我将按里程碑 A→F 开始落地实现，并在每个里程碑交付可运行预览与验证。