## 当前行为梳理
- 窗口类与样式：自定义 `CustomPanel: NSWindow`（非 NSPanel），样式 `styleMask [.titled, .fullSizeContentView]`，参见 Sources/QuiteNote/UI/FloatingPanelController.swift:124-136。
- 层级：始终 `panel.level = .floating`（确保置顶），参见 129、164。
- 桌面行为：`collectionBehavior = [.canJoinAllSpaces, .fullScreenAuxiliary]`，参见 132。
- 激活策略：应用默认 `.accessory`；`ensureVisibleOnLaunch()` 启动时先常规激活，若不可见或未成为 KeyWindow，临时切到 `.regular` 获取焦点后再切回 `.accessory`，参见 186-247。
- 可见性与焦点：`hidesOnDeactivate = false`（失焦仍显示），焦点状态通过通知同步到 `WindowFocusProvider`，参见 150-152、276-278。
- 拖拽区域：
  - 代码中关闭了“全窗背景拖动”：`panel.isMovableByWindowBackground = false`（参见 137），改为在左侧侧栏和 Header 叠加 `WindowDragHandler()` 的局部拖拽区域，参见 FloatingRootView 中 Sidebar/Header 的 `WindowDragHandler()`：314-316、381-383。
  - 同时支持“位置锁定”偏好：`onWindowLock` 中 `panel.isMovable = !lock`，参见 268-271。
- 输入门控：为了保证“只有关键窗口能输入”，在文本输入处加了 `disabled(!focus.isKeyWindow)`，参见 399-400。

## 卡顿与拖拽问题的可能原因
- 全局拖拽关闭：当前依赖局部 `WindowDragHandler` 覆盖区域。若用户在非覆盖区域拖动会无效；若 `overlay`/`ZStack` 的命中测试遮挡，也会导致拖拽区域不生效。
- 激活策略切换：Accessory ↔ Regular 切换在部分 macOS 和全屏场景会带来短暂抖动（窗口前后顺序变化），让交互感知“卡顿”。
- 失焦状态下仍浮动：由于 `hidesOnDeactivate = false` 与 `.floating`，窗口在失焦仍可见，但输入被禁用，可能给人“卡住”的感受。

## 改进方案（实现步骤）
1) 拖拽体验统一与扩展
- 将 `panel.isMovableByWindowBackground` 与“位置锁定”联动：当未锁定时设为 `true`，实现全窗背景可拖拽；锁定时设为 `false`。
- 保留 Sidebar/Header 的 `WindowDragHandler`，但为所有装饰性 `overlay(Rectangle...)` 添加 `.allowsHitTesting(false)`，避免遮挡拖拽命中（Header 已采用此策略，继续全局排查）。

2) 激活策略平滑化
- 优化 `ensureVisibleOnLaunch()` 的时序：
  - 第一次激活 `NSApp.activate` + `makeKeyAndOrderFront` + `orderFrontRegardless`。
  - 仅当检测到 `!isKey || !isVisible` 时才短暂切到 `.regular`，缩短延迟（例如 300ms）后切回 `.accessory` 并再次 `orderFrontRegardless`。
- 在 `hide()` 中保留切回 `.accessory`，但避免多余动画叠加导致卡顿（保留一次动画）。

3) 焦点与输入感知
- 在 `didBecomeKey/didResignKey` 日志中打印：`policy`、`level`、`isKey`、`isVisible`、`collectionBehavior`，便于定位“键窗口”切换不顺畅。
- 非关键窗口时：保持浮窗可见（便捷查看）、禁用输入控件（已有）；若用户希望更强的失焦感知，可在失焦时降低透明度（例如 0.9→0.85），但先按你现有需求不改。

4) 验证用例
- 拖拽：
  - “位置锁定”关闭时，全窗任意位置可拖动；打开时不可拖动。
- 激活切换：
  - 启动自动显示 → 切外部 App → 再切回；观察日志与视觉是否抖动明显减少。
- 输入门控：
  - KeyWindow 时搜索框与任何文本可输入；ResignKey 后禁用。

## 交付
- 调整 `FloatingPanelController`：
  - 初始化时的 `isMovableByWindowBackground` 改为依偏好项设定；
  - `onWindowLock` 中同步 `isMovableByWindowBackground`；
  - 优化 `ensureVisibleOnLaunch()` 的延时参数与切换顺序；
  - 添加更详细的焦点/policy/level 日志。
- 排查并为所有装饰性 overlay 添加 `.allowsHitTesting(false)`（已处理设置页，继续检查根视图 Header/分隔线）。

## 备注
- 保留 `.floating` 层级与 `.canJoinAllSpaces + .fullScreenAuxiliary`；不使用 `.moveToActiveSpace`（曾导致阻塞）。
- 继续保持 Accessory 模式的纯状态栏应用行为（无 Dock 图标），仅在需要时短暂切到 Regular 获取焦点。
